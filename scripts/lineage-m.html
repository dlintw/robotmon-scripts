<html>

<head>
  <style>
    .navbar-custom {
      border-radius: 0 !important;
      background-color: #2196F3;
      color: #FFFFFF;
    }

    .navbar-custom>a {
      width: 100%;
      color: #FFFFFF;
      text-align: center;
    }

    .navbar-custom>a:hover {
      color: #FFFFFF;
    }

    .list-group-item {
      padding: 6px 10px !important;
    }

    .switch {
      position: relative;
      display: inline-block;
      vertical-align: middle;
      margin: 0px;
      width: 52px;
      height: 28px;
    }

    .switch input {
      display: none;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      -webkit-transition: .4s;
      transition: .4s;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 24px;
      width: 24px;
      left: 2px;
      bottom: 4px;
      top: 2px;
      background-color: white;
      -webkit-transition: .4s;
      transition: .4s;
    }

    input:checked+.slider {
      background-color: #2196F3;
    }

    input:focus+.slider {
      box-shadow: 0 0 1px #2196F3;
    }

    input:checked+.slider:before {
      -webkit-transform: translateX(24px);
      -ms-transform: translateX(24px);
      transform: translateX(24px);
    }

    .slider.round {
      border-radius: 28px;
    }

    .slider.round:before {
      border-radius: 50%;
    }

    .btn {
      margin-left: 5px;
    }

    .btn-plus {
      color: #FFFFFF;
      background-color: #2196F3;
      border-color: #2196F3;
    }

    .btn-plus:hover,
    .btn-plus:focus,
    .btn-plus:active,
    .btn-plus.active {
      color: #FFFFFF !important;
      background-color: #0d8aee;
      border-color: #0c7cd5;
    }

    .btn-plus.disabled:hover,
    .btn-plus.disabled:focus,
    .btn-plus.disabled:active,
    .btn-plus.disabled.active,
    .btn-plus[disabled]:hover,
    .btn-plus[disabled]:focus,
    .btn-plus[disabled]:active,
    .btn-plus[disabled].active,
    fieldset[disabled] .btn-plus:hover,
    fieldset[disabled] .btn-plus:focus,
    fieldset[disabled] .btn-plus:active,
    fieldset[disabled] .btn-plus.active {
      color: #FFFFFF;
      background-color: #2196F3;
      border-color: #2196F3;
    }

    .btn-plus,
    .btn-danger,
    .btn-warning,
    .btn-success {
      min-width: 25px;
      min-height: 25px;
      padding: 1px 0px 1px 0px !important;
    }

    .btn-circle {
      min-width: 30px;
      min-height: 30px;
      width: 30px;
      height: 30px;
      text-align: center;
      padding: 5px 0;
      border-radius: 15px;
      border: 0px;
    }

    .row {
      display: flex;
      align-items: center;
    }

    ul {
      padding-left: 5px;
    }

    .setting_input {
      text-align: center;
      display: inline-block;
      margin-left: 5px;
    }
  </style>

  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/i18next/10.0.7/i18next.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-i18next/1.2.1/jquery-i18next.js"></script>

  <script>
    if (typeof String.prototype.startsWith != 'function') {
      // see below for better implementation!
      String.prototype.startsWith = function (str){
        return this.indexOf(str) === 0;
      };
    }

    TAG = "LineageM";
    VERSION = 1;
    var settings = {
      conditions: [
        {type: 'mp', op: -1, value: 70, btn: 0, interval: 1000, enabled: true}, // if mp < 70% use 1th button, like 魂體
        {type: 'hp', op: -1, value: 75, btn: 1, interval: 1000, enabled: true}, // if hp < 75% use 2th button, like 高治
        {type: 'hp', op: -1, value: 40, btn: 2, interval: 1000, enabled: true}, // if hp < 40% use 3th button, like 瞬移
        {type: 'hp', op: -1, value: 25, btn: 3, interval: 1000, enabled: true}, // if hp < 25% use 4th button, like 回卷
        {type: 'mp', op:  1, value: 80, btn: 4, interval: 1000, enabled: true}, // if mp > 80% use 5th button, like 三重矢, 光箭, 火球等
        {type: 'hp', op:  1, value: 75, btn: 5, interval: 1000, enabled: false},
        {type: 'hp', op:  1, value: 75, btn: 6, interval: 1000, enabled: false},
        {type: 'hp', op:  1, value: 75, btn: 7, interval: 1000, enabled: false},
      ],
      inHomeUseBtn: -1, // if in safe region use 3th button, like 瞬移. -1 = disable
      goBackInterval: 0, // 0 = 不回原點
    };

    $(function () {
      $("#version").html(TAG + " v" + VERSION);
      initLocale();
      loadSettings();
      updateLocale();
    });

    function updateLocale() {
      $('.container').localize();
    }

    function initLocale() {
      i18next.init({
        lng: 'en',
        resources: {
          en: {
            translation: {
              text: {
                language: "Language",
                interval: "Interval",
                milliseconds: "ms",
                hotkey: "Hotkey",
              }
            }
          },
          zh_TW: {
            translation: {
              text: {
                language: "語言",
                interval: "間隔",
                milliseconds: "毫秒",
                hotkey: "快捷鍵",
              }
            }
          }
        }
      }, function (err, t) {
        jqueryI18next.init(i18next, $);
        if (localStorage !== undefined) {
          var locale = localStorage.getItem(getLocaleKey());
          if (locale != null) {
            i18next.changeLanguage(locale)
          }
        }
      });
      i18next.on('languageChanged', function() {
        if (localStorage !== undefined) {
          localStorage.setItem(getLocaleKey(), i18next.language);
        }
        updateLocale();
      });
    }

    function getSettingKey() {
      return TAG + '-settings';
    }

    function getVersionKey() {
      return TAG + '-version';
    }

     function getLocaleKey() {
      return TAG + '-locale';
    }

    function loadSettings() {
      if (localStorage === undefined) {
        return;
      }
      var tempSettings = localStorage.getItem(getSettingKey());
      settings = tempSettings == null ? settings : JSON.parse(tempSettings);
     
      $('#group').empty();

      for (var index = 0; index < settings.conditions.length; index++) {
        // condition in settings
        var condition = settings.conditions[index];

        var jGroup = $('#group');
        var jGroupItem = $("<li class='list-group-item' style='background-color:#ffffff;margin-left:0px !important;'></li>");
        var jRow = $("<div class='row'></div>");
        var jLeftContent = $("<div class='col-xs-10'></div>");
        var jContent = [];

        // type
        var jBtnType = $("<button class='btn'><i class='fa fa-flask' aria-hidden='true'></i></button>");
        if (condition.type === 'hp') {
          jBtnType.addClass('btn-danger');
        } else if (condition.type === 'mp') {
          jBtnType.addClass('btn-plus');
        }
        jBtnType.click((function (btn, condition) {
          return function () {
            if (btn.hasClass('btn-plus')) {
              btn.removeClass('btn-plus').addClass('btn-danger');
              condition.type = 'hp';
            } else {
              btn.removeClass('btn-danger').addClass('btn-plus');
              condition.type = 'mp';
            }
            saveSettings();
          }
        })(jBtnType, condition));

        // op
        var jBtnOp = $("<button class='btn btn-success'><i class='fa' aria-hidden='true'></i></button>");
        if (condition.op > 0) {
          jBtnOp.find('i').addClass('fa-angle-right');
        } else {
          jBtnOp.find('i').addClass('fa-angle-left');
        }
        jBtnOp.click((function (btn, condition) {
          return function () {
            var i = btn.find('i');
            if (i.hasClass('fa-angle-right')) {
              i.removeClass('fa-angle-right').addClass('fa-angle-left');
              condition.op = -1;
            } else {
              i.removeClass('fa-angle-left').addClass('fa-angle-right');
              condition.op = 1;
            }
            saveSettings();
          }
        })(jBtnOp, condition));

        // value
        var valueMax = 95;
        var valueMin = 5;
        var valueStep = 5;
        var jValueInput = $("<div class=setting_input>" + condition.value + "</div>");
        var jValueBtn = $('<button class="btn btn-warning">+' + valueStep + '</button>');
        jValueBtn.click((function (jInput, min, max, step, condition) {
          return function () {
            var newValue = (+jInput.text()) + step;
            if (newValue > max) {
              jInput.text(min);
              condition.value = min;
            } else {
              jInput.text(newValue);
              condition.value = newValue;
            }
            saveSettings();
          }
        })(jValueInput, valueMin, valueMax, valueStep, condition));

        // interval
        var intervalMax = 15000;
        var intervalMin = 500;
        var intervalStep = 500;
        var jIntervalInput = $("<div class=setting_input>" + condition.interval + "</div>");
        var jIntervalBtn = $('<button class="btn btn-warning">+' + intervalStep + '</button>');
        jIntervalBtn.click((function (jInput, min, max, step, condition) {
          return function () {
            var newValue = (+jInput.text()) + step;
            if (newValue > max) {
              jInput.text(min);
              condition.interval = min;
            } else {
              jInput.text(newValue);
              condition.interval = newValue;
            }
            saveSettings();
          }
        })(jIntervalInput, intervalMin, intervalMax, intervalStep, condition));

        // push to content
        jContent.push($("<div class=setting_input data-i18n='text.hotkey'></div>"));
        jContent.push($("<div class=setting_input>" + (condition.btn + 1) + "</div>"));
        jContent.push(jBtnType);
        jContent.push(jBtnOp);
        jContent.push(jValueInput);
        jContent.push("%");
        jContent.push(jValueBtn);
        jContent.push($("<div class=setting_input data-i18n='text.interval'></div>"));
        jContent.push(jIntervalInput);
        jContent.push($("<div class=setting_input data-i18n='text.milliseconds'></div>"));
        jContent.push(jIntervalBtn);

        // append content to row
        for (var j in jContent) {
          jGroup.append(jGroupItem.append(jRow.append(jLeftContent.append(jContent[j]))));
        }

        // switch
        var jDiv = $('<div class="pull-right"></div>');
        var jCol = $('<div class="col-xs-2"></div>');
        var jSwitch = $('<label class="switch pull-right"></label>');
        var jSwitchInput = $("<input class='setting_input' type='checkbox' " + (condition.enabled ? 'checked' : '') + "/>");
        jSwitchInput.change((function (jInput, condition) {
          return function () {
            condition.enabled = jInput.is(':checked');
            saveSettings();
          }
        })(jSwitchInput, condition));
        jSwitch.append(jSwitchInput);
        jSwitch.append('<a class="slider round"></a>');
        jRow.append(jCol.append(jDiv.append(jSwitch)));
      }
    }

    function saveSettings() {
      if (localStorage === undefined) {
        return;
      }
      localStorage.setItem(getVersionKey(), VERSION);
      localStorage.setItem(getSettingKey(), JSON.stringify(settings));
    }

    function getSettings() {
      var tempSettings = $.extend(true, {}, settings);;
      var tempConditions = [];
      for (var index = 0; index < settings.conditions.length; index++) {
        var condition = settings.conditions[index];
        if (condition.enabled) {
          tempConditions.push(condition);
        }
      }
      tempSettings.conditions = tempConditions;
      return tempSettings;
    }

    function onEvent(eventType) {
      if (eventType == 'OnPlayClick') {
        JavaScriptInterface.runScript('start(\'' + JSON.stringify(getSettings()) + '\');');
      } else if (eventType == 'OnPauseClick') {
        JavaScriptInterface.runScript('stop();');
      }
    }
    function onLog(message) {
      console.log(message);
    }
  </script>
</head>

<body>
  <nav class="navbar navbar-custom" role="navigation">
    <a id="version" class="navbar-brand"></a>
  </nav>
  <div id="container" class="container">
    <ul class="list-group">
      <li class="list-group-item">
        <div class="row">
          <div class="col-xs-6" data-i18n="text.language"></div>
          <div class="col-xs-6">
            <div class="pull-right">
              <button onclick="i18next.changeLanguage('en')" class="btn btn-plus">EN</button>
              <button onclick="i18next.changeLanguage('zh_TW')" class="btn btn-plus">中文</button>
            </div>
          </div>
        </div>
      </li>
    </ul>
    <ul id="group" class="list-group"></ul>
    <div>若要使用瞬捲或回捲，請將瞬捲放在快捷鍵 7，回捲放在快捷鍵 8。</div>
  </div>
</body>

</html>